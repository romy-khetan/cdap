#!/usr/bin/env bash
#
# Copyright © 2016 Cask Data, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.

#
# This script is the main script for performing all CDAP functions. With it,
# you can start, stop, or get status on CDAP and its services, run queries,
# execute CLI commands, and more. Anything not handled by this script is passed
# to the CDAP CLI to be interpreted. 
#

# This is the same as "cdap_home" function in functions.sh
# If you need code like this, source functions.sh and use the function, DO NOT COPY THIS CODE
readonly __zero=${0}
__ls= __link= __prg=
# Resolve links: $0 may be a link
__prg=${__zero}
# Need this for relative symlinks.
while [[ -h ${__prg} ]] ; do
  __ls=$(ls -ld "${__prg}")
  __link=$(expr "${__ls}" : '.*-> \(.*\)$')
  if expr "${__link}" : '/.*' >/dev/null; then
    __prg=${__link}
  else
    __prg=$(dirname "${__prg}")"/${__link}"
  fi
done
cd "$(dirname \"${__prg}\")/.." 2>/dev/null >&-
export CDAP_HOME=$(pwd -P)
### end cdap_home

# Source our functions script, which will be located with us
source "${CDAP_HOME}"/bin/functions.sh

# Do a small sanity check
if [[ ${CDAP_HOME} != $(cdap_home) ]]; then
  die "CDAP_HOME doesn't match output of cdap_home function! Aborting!"
fi

# Load user-modifiable configuration
test -f "${CDAP_CONF}"/cdap-env.sh && source "${CDAP_CONF}"/cdap-env.sh

# Main script, handles options and Does the Right Thing™
case ${1} in
  auth-server|kafka-server|master|router|ui) CDAP_SERVICE=${1}; shift; cdap_service ${CDAP_SERVICE} ${@}; __ret=${?} ;;
  cli|shell) shift; cdap_cli ${@}; __ret=${?} ;;
  config-tool) shift; cdap_config_tool ${@}; __ret=${?} ;;
  run) shift; run ${@}; __ret=${?} ;;
  sdk|standalone) shift; cdap_sdk ${@}; __ret=${?} ;;
  tx-debugger) shift; cdap_tx_debugger ${@}; __ret=${?} ;;
  *) cdap_cli ${@}; __ret=${?} ;;
esac

exit ${__ret}
